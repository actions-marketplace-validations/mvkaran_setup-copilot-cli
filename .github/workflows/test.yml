name: Test Action

on:
  push:
    branches: [ main, copilot/** ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-installation:
    name: Install ${{ matrix.version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        version: [latest, prerelease, '0.0.386']
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup GitHub Copilot CLI
        id: setup-copilot
        uses: ./
        with:
          version: ${{ matrix.version }}

      - name: Verify installation
        shell: bash
        run: |
          echo "Version: ${{ steps.setup-copilot.outputs.version }}"
          echo "Path: ${{ steps.setup-copilot.outputs.path }}"
          copilot -v

  test-nodejs-versions:
    name: Node.js ${{ matrix.node-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node-version: [18, 20, 22, 24]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Setup GitHub Copilot CLI
        id: setup-copilot
        uses: ./
        with:
          version: latest

      - name: Verify installation
        shell: bash
        run: |
          echo "Node.js version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo "Copilot CLI version: ${{ steps.setup-copilot.outputs.version }}"
          copilot -v

  test-token-setup:
    name: Token setup on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup GitHub Copilot CLI with token
        id: setup-copilot
        uses: ./
        with:
          version: latest
          token: ${{ secrets.COPILOT_TOKEN }}

      - name: Verify GH_TOKEN is set
        shell: bash
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "❌ GH_TOKEN is not set"
            exit 1
          fi
          echo "✓ GH_TOKEN is set"
          echo "Copilot CLI version: ${{ steps.setup-copilot.outputs.version }}"
          copilot -v
